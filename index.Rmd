---
title: Fish biodiversity in Marine World Heritage Sites
date: "`r Sys.Date()`"
author: Pieter Provoost
output: (function(...) {
  rmdformats::robobook(toc_depth = 4, pandoc_args = c("+RTS", "-K2000m", "-RTS"), ...) })
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "docs") })  
---

This notebook explores fish diversity in Marine World Heritage Sites using OBIS data.

## Fish species in WoRMS

First read all WoRMS species. As it's not possible to get a full species list from the WoRMS or GBIF web services, I'm reading directly from an export provided by WoRMS.

```{r message=FALSE, warning=FALSE}
library(dplyr)

worms <- read.csv("worms.txt", sep = "\t", quote = "") %>%
  as_tibble() %>%
  filter(taxonRank == "Species" & taxonomicStatus == "accepted") %>%
  select(scientificName, phylum, class, order) %>%
  mutate(species_fish = ifelse(class %in% c("Actinopterygii", "Coelacanthi", "Elasmobranchii", "Holocephali"), scientificName, NA))
```

Here I'm using the `rredlist` package to get all Red List species from IUCN:

```{r message=FALSE, warning=FALSE}
library(dplyr)
library(rredlist)

redlist <- tibble()
page <- 0

while (TRUE) {
  res <- rl_sp(page, key = "a936c4f78881e79a326e73c4f97f34a6e7d8f9f9e84342bff73c3ceda14992b9")$result
  if (length(res) == 0) {
    break
  }
  redlist <- bind_rows(redlist, res)
  page <- page + 1
}

redlist <- redlist %>%
  as_tibble() %>%
  filter(category %in% c("CR", "EN", "VU", "EW", "EX"))
```

Now let's label Red List species in the `worms` data frame.

```{r message=FALSE, warning=FALSE}
worms <- worms %>%
  mutate(species_vulnerable = ifelse(scientificName %in% redlist$scientific_name, scientificName, NA)) %>%
  mutate(species_vulnerable_fish = ifelse(!is.na(species_fish) & scientificName %in% redlist$scientific_name, scientificName, NA)) 
```

And calculate some statistics:

```{r message=FALSE, warning=FALSE}
library(knitr)

worms %>%
  summarize(
    species = n(),
    fish = length(unique(species_fish)),
    vulnerable = length(unique(species_vulnerable)),
    vulnerable_fish = length(unique(species_vulnerable_fish))
  ) %>%
  kable(format.args = list(big.mark = ","))
```

## Fish data in OBIS

```{r message=FALSE, warning=FALSE}
library(robis)

if (!file.exists("checklist.Rdata")) {
  cl <- checklist(dropped = "include")
  cl <- cl %>%
    filter(is_marine | is_brackish) %>%
    mutate(species_fish = ifelse(superclass == "Pisces", species, NA)) %>%
    mutate(species_vulnerable = ifelse(category %in% c("VU", "EN", "CR"), species, NA)) %>%
    mutate(species_vulnerable_fish = ifelse(superclass == "Pisces" & category %in% c("VU", "EN", "CR"), species, NA))
  save(cl, file = "checklist.Rdata")
} else {
  load("checklist.Rdata")
}

cl %>%
  summarize(
    records = sum(records),
    species = length(unique(species)),
    fish = length(unique(species_fish)),
    vulnerable = length(unique(species_vulnerable)),
    vulnerable_fish = length(unique(species_vulnerable_fish))
  ) %>%
  kable(format.args = list(big.mark = ","))
```

## Fish data for the Marine World Heritage Sites
### Fetch spatial data

First fetch the Marine World Heritage Sites shapefile from MarineRegions:

```{r message=FALSE, warning=FALSE}
library(sf)
library(dplyr)

if (!file.exists("shape/worldheritagemarineprogramme.shp")) {
  download.file("http://geo.vliz.be/geoserver/wfs?request=getfeature&service=wfs&version=1.0.0&typename=MarineRegions:worldheritagemarineprogramme&outputformat=SHAPE-ZIP", "shape.zip")
  unzip("shape.zip", exdir = "shape")
}

shapes <- st_read("shape/worldheritagemarineprogramme.shp") %>%
  select(full_name, country, geometry) %>%
  mutate(full_name = iconv(full_name, "latin1", "UTF-8"))
```

Let's create a map.

```{r message=FALSE, warning=FALSE}
library(mapview)
mapviewOptions(fgb = FALSE)

mapview(shapes)@map
```

### Process spatial data

```{r message=FALSE, warning=FALSE}
library(concaveman)
library(sfheaders)

shapes_processed <- shapes %>%
  mutate(geometry = sf_remove_holes(geometry)) %>%
  group_by(full_name) %>%
  summarize(geometry = st_union(geometry))

mapview(shapes, color = "red", lwd = 0.5, alpha = 1, alpha.regions = 0) +
  mapview(shapes_processed, color = "green", lwd = 0.5, alpha = 1, alpha.regions = 0, legend = FALSE)
```

### Fetch occurrence data

Here I'm fetching data from OBIS by area. OBIS is queried by bounding box, but a point-in-polygon calculation is used to discard points outside the areas.

```{r message=FALSE, warning=FALSE}
library(purrr)

occ_for_geom <- function(geom) {
  wkt <- st_as_text(st_as_sfc(st_bbox(geom)), digits = 6)
  message(wkt)
  occ <- occurrence(geometry = wkt, fields = c("scientificName", "species", "family", "order", "class", "superclass", "phylum", "decimalLongitude", "decimalLatitude", "date_year", "category", "dataset_id")) %>%
    st_as_sf(coords = c("decimalLongitude", "decimalLatitude"), crs = 4326)
  occ_filtered <- occ %>%
    filter(st_intersects(geometry, geom, sparse = FALSE)) %>%
    as_tibble() %>%
    select(-geometry)
  return(occ_filtered)
}

if (!file.exists("occurrence.Rdata")) {
  occs <- map(shapes_processed$geometry, occ_for_geom)
  for (i in 1:nrow(shapes_processed)) {
    occs[[i]]$full_name <- shapes_processed$full_name[i]
  }
  occ <- bind_rows(occs)

  occ <- occ %>%
    mutate(species_fish = ifelse(superclass == "Pisces", species, NA)) %>%
    mutate(species_vulnerable = ifelse(category %in% c("VU", "EN", "CR"), species, NA)) %>%
    mutate(species_vulnerable_fish = ifelse(superclass == "Pisces" & category %in% c("VU", "EN", "CR"), species, NA))

  save(occ, file = "occurrence.Rdata")
} else {
  load("occurrence.Rdata")
}
```

### Calculate statistics

```{r message=FALSE, warning=FALSE}
occ %>%
  filter(!is.na(species)) %>%
  summarize(
    records = n(),
    species = length(unique(species)),
    fish = length(unique(species_fish)),
    vulnerable = length(unique(species_vulnerable)),
    vulnerable_fish = length(unique(species_vulnerable_fish))
  ) %>%
  kable(format.args = list(big.mark = ","))
```

```{r message=FALSE, warning=FALSE}
site_stats <- occ %>%
  filter(!is.na(species)) %>%
  group_by(full_name) %>%
  summarize(
    records = n(),
    species = length(unique(species)),
    fish = length(unique(species_fish)),
    vulnerable = length(unique(species_vulnerable)),
    vulnerable_fish = length(unique(species_vulnerable_fish))
  )

site_stats %>%
  kable(format.args = list(big.mark = ","))
```

```{r message=FALSE, warning=FALSE}
library(ggplot2)
library(ftplottools)
library(ggrepel)

subset <- site_stats %>%
  filter(full_name %in% c("Great Barrier Reef", "Belize Barrier Reef Reserve System", "Ha Long Bay", "The Wadden Sea", "Heard and McDonald Islands", "Aldabra Atoll")) %>%
  arrange(full_name)

subset$x <- c(600, 100, 800, 500, 10, 60)
subset$y <- c(140, 80, 210, 3, 20, 40)

ggplot() +
  geom_segment(subset, mapping = aes(x = x, y = y, xend = fish, yend = vulnerable)) +
  geom_label(subset, mapping = aes(x = x, y = y, label = full_name), size = 3.5, label.size = 0) +
  geom_point(site_stats, mapping = aes(x = fish, y = vulnerable, size = species, color = species), shape = 21, stroke = 1.2, fill = "white") +
  scale_x_continuous(trans = "log10") +
  scale_y_continuous(trans = "log10") +
  scale_size(range = c(1, 8), breaks = c(1000, 5000, 10000)) +
  scale_color_viridis_c(end = 0.8, trans = "log10", breaks = c(1000, 5000, 10000)) +
  guides(color = guide_legend(), size = guide_legend()) +
  xlab("fish species") + ylab("vulnerable species") +
  ft_theme() +
  ggtitle("Fish and vulnerable species diversity at marine World Heritate sites")

ggsave("sites.png", width = 10, height = 6, dpi = 600)
```

## Fish DNA barcodes in molecular databases

Let's check BOLD for barcode sequences using all fish species in WoRMS:

```{r message=FALSE, warning=FALSE}
# fixes issue with bold package
invisible(Sys.setlocale("LC_ALL", "C"))

if (!file.exists("bold.Rdata")) {
  fish_species <- worms %>% filter(!is.na(species_fish)) %>% pull(species_fish) %>% unique()
  bold_list <- sapply(fish_species, function(x) NULL)
  for (i in 1:length(bold_list)) {
    message(i, " ", names(bold_list)[i])
    if (is.null(bold_list[[i]])) {
      bold_list[[i]] <- tryCatch({
        caspr::bold_statistics(names(bold_list)[i])
      }, warning = function(warning_condition) {
      }, error = function(error_condition) {
      }, finally = {
      })
    }
  }
  save(bold_list, file = "bold.Rdata")
} else {
  load("bold.Rdata")
}

sequence_numbers <- unlist(map(bold_list, nrow))
fish_sequences <- tibble(species = names(sequence_numbers), sequences = sequence_numbers) %>%
  filter(sequences > 0)
```

This tells us that barcode sequences exist in BOLD for `r format(nrow(fish_sequences), big.mark = ",")` WoRMS fish species.

Now we can check how many fish species reported in the marine World Heritage sites have barcodes in BOLD:

```{r message=FALSE, warning=FALSE}
occ %>%
  filter(species %in% fish_sequences$species) %>%
  summarize(species = length(unique(species))) %>%
  kable(format.args = list(big.mark = ","))
```
